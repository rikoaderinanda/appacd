@{
    ViewData["Title"] = "Status";
    ViewData["Header"] = "2";
    ViewData["Footer"] = "3";
    ViewData["HeaderName"] = "Detail Transaksi";
}

<style>
    /* ===== Styling Channel Payment ===== */
    .payment-channel-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .channel-card {
        position: relative;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 0;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.1s ease-in-out;
        flex: 1 1 150px;
        text-align: center;
        cursor: pointer;
    }

    .channel-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }

    .channel-card input[type="radio"]:checked + .channel-content {
        border: 2px solid #0d6efd;
        border-radius: 8px;
        padding: 2px;
        background-color: #f0f8ff;
    }

    .channel-content {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 80px;
        border-radius: 8px;
        transition: 0.1s;
    }

    .channel-content img {
        max-height: 60px;
        max-width: 100px;
        object-fit: contain;
    }

</style>

<style>
    /* Section Container */
    #sessionPaymentMethod {
        background: #f9fbfd;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Judul Section */
    #sessionPaymentMethod strong {
        font-size: 1rem;
        color: #0d6efd;
    }

    /* Toggle Button */
    #toggleDetailBtn {
        color: #0d6efd;
        transition: transform 0.2s ease-in-out;
    }
    #toggleDetailBtn:hover {
        transform: rotate(10deg);
    }

    /* Detail Transaksi Box */
    #listTransaksi {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        animation: fadeIn 0.3s ease-in-out;
    }

    /* Total Box */
    .alert-info {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #0d47a1;
        border: none;
        font-size: 0.95rem;
    }

    /* Input Cari */
    #searchInput {
        border: 2px solid #e9ecef;
        transition: border 0.2s;
    }
    #searchInput:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
    }

    /* Accordion */
    .accordion-button {
        background: #f1f5fb;
        font-weight: 600;
        color: #0d47a1;
    }
    .accordion-button:not(.collapsed) {
        background: #0d6efd;
        color: #fff;
    }

    .accordion-body {
        background: #ffffff;
        border-radius: 12px;
        padding: 15px;
    }

    /* Animasi */
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="app-body">
    <div class="container">
        <div class="row pt-30">
            <div class="main-title text-center mb-4">
                <h3 class="fw-bold text-primary mb-2">
                    <i class="bi bi-credit-card me-2"></i> Selesaikan Pembayaran Anda
                </h3>
                <p class="text-muted small mb-0">
                    Periksa kembali detail transaksi, lalu pilih metode pembayaran yang paling sesuai untuk Anda.
                </p>
            </div>
            <div class="pb-30" id="sessionPaymentMethod">

                <div id="IdTransaksi" class="position-relative mb-3"></div>

                <!-- Accordion Detail Order -->
                <div class="fw-semibold text-primary mb-1">
                    <i class="bi bi-person-vcard me-1"></i> Kontak & Alamat
                </div>

                <div class="p-3 border rounded bg-light medium mb-2">
                <!-- Kontak (1 baris) -->
                    <div class="mb-2 mt-2" id="KontakInfo">
                    </div>
                    <hr>
                <!-- Pemisah -->
                    <div class="mb-2 mt-2" id="AlamatInfo"></div>
                </div>
            
                <br>
                <div class="position-relative">
                    <strong><i class="bi bi-receipt-cutoff me-1"></i> Detail Transaksi</strong>
                    <a id="toggleDetailBtn" href="javascript:void(0)"
                        class="btn btn-sm position-absolute top-0 end-0">
                        <i id="toggleIcon" class="bi bi-chevron-down fs-5"></i>
                    </a>
                </div>

                <!-- List Transaksi -->
                <div id="listTransaksi" class="card-text mb-3 mt-3" style="display:block;"></div>

                <!-- Total -->
                <div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm rounded-pill px-3 py-2 mt-3">
                    <span class="fw-bold"><i class="bi bi-cash-coin me-1"></i> Total Transaksi:</span>
                    <span class="fw-bold text-primary fs-5" id="totalTransaksi">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </span>
                </div>

                <!-- Metode Pembayaran -->
                <div class="mt-4">
                    <strong><i class="bi bi-credit-card me-1"></i> Metode Pembayaran</strong>
                    <div class="position-relative mb-4 mt-2">
                        <input class="form-control ps-5 pe-5 shadow-sm rounded-pill" 
                            type="text" placeholder="Cari metode..." id="searchInput">
                        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                        <button type="button"
                            class="btn btn-light btn-sm rounded-circle shadow-sm position-absolute top-50 end-0 translate-middle-y me-2"
                            onclick="GetChannelPembayaran()" title="Segarkan">
                            <i class="bi bi-arrow-clockwise text-primary"></i>
                        </button>
                    </div>
                </div>

                <div class="accordion mt-4 mb-3" id="channelAccordion"></div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="gobo-custom-footer gobo-shadow fixed-bottom m-0 px-2 py-2 text-center">
    <div class="container p-0">
        <div class="row">
            <div class="col-6">
                <button type="button" class="btn btn-outline-secondary w-100 fw-4 h_40 br-8" onclick="gotoBack();">
                    <i class="bi bi-arrow-left me-2"></i>Kembali
                </button>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-primary text-white w-100 fw-4 h_40 br-8" onclick="checkout();" id="btnCheckout">
                    <i class="bi bi-credit-card me-2"></i>Checkout
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Footer End -->
<script>

    var $;
    var dataTrx = {};
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.jQuery === 'undefined') {
            console.error('jQuery is not loaded.');
            return;
        }
        $ = window.jQuery;

        dataTrx = Storage.get("DataTrx");
        if(!isEmptyObject(dataTrx)){
            renderDataTransaksi(dataTrx);
        }

        const savedChannels = Storage.get("ChannelPayment");
        if (savedChannels) {
            SetChannelPembayaranV2(savedChannels, "");
        } else {
            GetChannelPembayaran();
        }

        // Event search
        $('#searchInput').on('keydown', function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const keyword = $(this).val().trim();
                const ChannelPayment = Storage.get("ChannelPayment");
                $('#btnCheckout').fadeOut();

                SetChannelPembayaranV2(ChannelPayment, keyword || "");
            }
        });
        // Toggle detail transaksi
        document.getElementById("toggleDetailBtn").addEventListener("click", function () {
            const list = document.getElementById("listTransaksi");
            const icon = document.getElementById("toggleIcon");
            const isHidden = list.style.display === "none";

            list.style.display = isHidden ? "block" : "none";
            icon.className = isHidden ? "bi bi-chevron-up" : "bi bi-chevron-down";
        });
    });

    function renderDataTransaksi(data){
        let Total = 0;
        console.log(data);
        $("#KontakInfo").html(`
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-person-circle me-2 text-primary" style="font-size:1.2rem; line-height:1;"></i>
                <span class="fw-semibold">${data.kontakPelanggan.nama}</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="bi bi-telephone-fill me-2 text-success" style="font-size:1.2rem; line-height:1;"></i>
                <span>${data.kontakPelanggan.nomor}</span>
            </div>
            `
        );

        $("#AlamatInfo").html(`
            <!-- Alamat ringkas (jenis + judul) -->
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-building me-1 text-warning"></i> ${data.jenisProperti.nama_jenis}
            </div>
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-tag-fill me-1 text-info"></i> ${data.alamatPelanggan.judul}
            </div>

            <!-- Alamat lengkap + Map -->
            <div class="d-flex justify-content-between align-items-center">
                <span>
                <i class="bi bi-geo-alt-fill me-1 text-danger"></i> 
                ${data.alamatPelanggan.alamat}
                <br>
                <small class="text-muted mb-1">${data.alamatPelanggan.kelurahan_nama}, ${data.alamatPelanggan.kecamatan_nama}</small>
                <small class="text-muted">${data.alamatPelanggan.kota_nama}, ${data.alamatPelanggan.provinsi_nama}</small>
                </span>
                <a href="https://maps.google.com?q=-6.917464,107.619123" target="_blank" class="text-decoration-none text-primary">
                <i class="bi bi-map-fill fs-5"></i>
                </a>
            </div>
        `);

        if(data.jenisLayanan == "MEMBER")
        {
            regmember = `<span class="text-danger">Berlangganan</span>`;
        }
        else{
            regmember = `<span class="text-dark">Reguler</span>`;
        }
        $("#IdTransaksi").html(`
            <div>
                <h5 class="card-title mb-1 fw-bold">
                    <span class="text-primary">ACD - ${formatToSixDigits(data.id)}</span>
                </h5>
                <button onclick="editTransaksi()" 
                        class="btn btn-outline-primary btn-sm position-absolute top-0 end-0"
                        style="border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-pencil" style="font-size: 1rem;"></i>
                </button>
            </div>
            <p class="card-text mb-0">
                <span class="text-dark">Layanan ${data.kategoriLayanan}</span>
                <span class="fw-semibold text-success">${regmember}</span>
            </p>
        `);



        if(data.jenisLayanan =="REG"){
            const expired = checkDateAndTimeVisitOrder(data.kunjungan.Reguler.tanggal, data.kunjungan.Reguler.jam);
            let expVisitStatus = "";
            if(expired){
                expVisitStatus = `
                    <!-- Badge Expired -->
                    <div class="mt-2">
                        <span class="badge bg-danger">Expired</span>
                    </div>

                    <!-- Button Reschedule -->
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary">
                            Reschedule
                        </button>
                    </div>
                `;
            }
            var scr =`
                <div class="fw-bold text-prima">Kunjungan Layanan Reguler</div>
                <small class="text-muted">pada tanggal ${data.kunjungan.Reguler.tanggal} jam ${data.kunjungan.Reguler.jam}</small>
                ${expVisitStatus}
            `;
            $("#listTransaksi").append(scr);

            $.map(data.cartItem.Reguler, function (item) {
                var scr =`
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <div class="fw-bold">${item.nama}</div>
                            <small class="text-muted">${formatRupiah(item.after_diskon)} x ${item.qty}</small>
                        </div>
                        <div class="fw-bold">${formatRupiah(item.after_diskon*item.qty)}</div>
                    </div>
                `;
                $("#listTransaksi").append(scr);
                
                Total = Total + (item.after_diskon*item.qty);
            });

            $("#listTransaksi").append(`
                <div class="d-flex justify-content-between align-items-center mt-30">
                    <div>      
                        <div class="fw-bold">Sub Total</div>
                    </div>
                    <div class="fw-bold">${formatRupiah(Total)}</div>
                </div>
            `);
            var scr =`
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">Biaya properti : ${data.jenisProperti.nama_jenis}</div>
                    </div>
                    <div class="fw-bold">${formatRupiah(data.jenisProperti.harga)}</div>
                </div>
            `;
            $("#listTransaksi").append(scr);
            Total = Total + (data.jenisProperti.harga);
        }
        else if(data.jenisLayanan =="MEMBER"){
            console.log(data);
            $("#listTransaksi").append(`
                <p class="fw-bold text-prima mb-0">
                    Berlangganan : ${data.paketMember.nama_paket} 
                    <br>
                    <small class="text-muted">${data.paketMember.deskripsi}</small>
                <p>
            `);
            
            $.map(data.kunjungan.Member, function (idx) {
                var scr =`
                    <div class="fw-bold text-prima">Kunjungan ke-${idx.idx}</div>
                    <small class="text-muted">pada tanggal ${idx.tgl} jam ${idx.jam}</small>
                `;
                $("#listTransaksi").append(scr);
                $.map(data.cartItem.Reguler, function (item) {
                    var scr =`
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>      
                                <div class="fw-bold">${item.nama}</div>
                                <small class="text-muted">${formatRupiah(item.after_diskon)} x ${item.qty}</small>
                            </div>
                            <div class="fw-bold">${formatRupiah(item.after_diskon*item.qty)}</div>
                        </div>
                    `;
                    $("#listTransaksi").append(scr);
                    Total = Total + (item.after_diskon*item.qty);
                });
                $("#listTransaksi").append(`<div class="mt-4 mb-3"></div>`);
            });

            $("#listTransaksi").append(`
                <div class="d-flex justify-content-between align-items-center mt-30">
                    <div>      
                        <div class="fw-bold">Sub Total</div>
                    </div>
                    <div class="fw-bold">${formatRupiah(Total)}</div>
                </div>
            `);
            
            let diskon = ((Total*data.paketMember.diskon)/100);
            $("#listTransaksi").append(`
                <div class="d-flex justify-content-between align-items-center">
                    <div>      
                        <div class="fw-bold">Diskon berlangganan</div>
                    </div>
                    <div class="fw-bold">-${formatRupiah(diskon)}</div>
                </div>
            `);
            Total = Total - diskon;
            var scr =`
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">Biaya properti : ${data.jenisProperti.nama_jenis}</div>
                    </div>
                    <div class="fw-bold">${formatRupiah(data.jenisProperti.harga)}</div>
                </div>
            `;
            $("#listTransaksi").append(scr);
            Total = Total + (data.jenisProperti.harga);
            
        }
        $("#totalTransaksi").text(formatRupiah(Total));
    }

    function GetChannelPembayaran() {
        callApi({
            url: `/api/Tripay/GetPaymentChannelsV2`,
            method: 'GET',
            success: function (res) {
                Storage.set("ChannelPayment", res);
                SetChannelPembayaranV2(res, "");
            },
            error: function () {
                Swal.fire('Gagal!', 'Proses gagal.', 'warning');
            },
            onBeforeSend: function () {
                $('#channelAccordion').html('<p class="text-center text-muted py-4">Sedang memuat data...</p>');
            }
        });
    }
    
    function SetChannelPembayaranV2(res, cari) {
        if (cari === "") $("#searchInput").val("");

        // Grouping berdasarkan "group"
        const grouped = {};
        const regex = cari ? new RegExp(cari, "i") : null;

        res.forEach(item => {
            if (!regex || regex.test(item.name)) {
                if (!grouped[item.group]) grouped[item.group] = [];
                grouped[item.group].push(item);
            }
        });

        const accordion = $("#channelAccordion");
        accordion.empty();

        let idx = 0;
        Object.keys(grouped).forEach(group => {
            const collapseId = `collapse-${idx}`;
            const headerId = `heading-${idx}`;

            const items = grouped[group].map(item => `
                <div class="payment-channel-list">
                    <label class="channel-card">
                        <input type="radio" name="payment_channel" value="${item.code}" class="form-check-input d-none" />
                        <div class="channel-content">
                            <img src="${item.icon_url}" alt="${item.name}" width="80">
                        </div>
                    </label>
                </div>
            `).join("");

            const section = `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                aria-expanded="${idx === 0}" aria-controls="${collapseId}">
                            ${group}
                        </button>
                    </h2>
                    <div id="${collapseId}" 
                         class="accordion-collapse collapse ${cari ? 'show' : ''}" 
                         aria-labelledby="${headerId}" data-bs-parent="#channelAccordion">
                        <div class="accordion-body">
                            ${items}
                        </div>
                    </div>
                </div>
            `;

            accordion.append(section);
            idx++;
        });
    }

    function gotoBack(){
        window.history.back();
        //window.location.href = '@Url.Action("Index", "Home")';
    }

    function editTransaksi (){
        if(!isEmptyObject(dataTrx)){
            if(dataTrx.kategoriLayanan=="CUCI AC"){
                window.location.href = '@Url.Action("CuciAc", "Layanan")';
            }
            else if(dataTrx.kategoriLayanan=="PERBAIKAN AC"){
                window.location.href = '@Url.Action("Perbaikan", "Layanan")';
            }
        }
    }

    async function checkout(){
        console.log(dataTrx);
        let chekexp = checkDateAndTimeVisitOrder(dataTrx.kunjungan.Reguler.tanggal,dataTrx.kunjungan.Reguler.jam);
        if(chekexp){
            showToast("Waktu visit yang diorder melewati waktu saat ini, silahkan atur ulang waktu visit");
        }
        else
        {
            if ($('input[name="payment_channel"]:checked').length > 0)
            {
                var method = $('input[name="payment_channel"]:checked').val();
                await setDataCheckOut(dataTrx,method);
            }
            else
            {
                showToast("Silahkan pilih metode pembayaran");
            }
        }
    }
    
    async function setDataCheckOut(datatrx,method){
        if (datatrx.id > 0) {
            var _order_items = [];
            $.map(datatrx.cartItem.Reguler, function (item) {
                if(!isEmptyObject(datatrx.paketMember)){
                    let qtymember = datatrx.paketMember.qty;
                    var dt = {
                        sku: item.id,
                        name: `${datatrx.paketMember.nama_layanan} - ${datatrx.paketMember.nama_paket} - ${datatrx.paketMember.deskripsi}`,
                        price: datatrx.paketMember.total,
                        quantity: 1
                    };
                    _order_items.push(dt);
                }
                else
                {
                    var dt = {
                        sku: item.id,
                        name: item.nama,
                        price: item.after_diskon,
                        quantity: item.qty
                    };
                    _order_items.push(dt);
                }
            });
            
            var dt = {
                sku: datatrx.jenisProperti.id,
                name: 'biaya Properti: ' + datatrx.jenisProperti.nama_jenis,
                price: datatrx.jenisProperti.harga,
                quantity: 1
            };
            _order_items.push(dt);

            let emailuser = Storage.get('email');

            var dataCheckOut = {
                method: method,
                merchant_ref: `ACD-${formatToSixDigits(datatrx.id)}`,
                amount: datatrx.totalTransaksi,
                customer_name: datatrx.kontakPelanggan.nama,
                customer_email: emailuser,
                customer_phone: datatrx.kontakPelanggan.nomor,
                order_items: _order_items,
                callback_url: '',
                return_url: '',
                expired_time: 0,
                signature: ''
            };
            
            console.log(dataCheckOut);
            
            var checkout = await InstruksiBayar(dataCheckOut,{id:"btnCheckout",txtProcess:"Memproses...",txtfinish:"Checkout"});
            
            console.log(checkout);
            
            if (checkout.success) {
                var tripay_reff =
                {
                    reference : checkout.data.reference,
                    merchant_ref : checkout.data.merchant_ref,
                    payment_method : checkout.data.payment_method,
                    payment_name : checkout.data.payment_name,
                    amount : checkout.data.amount,
                    fee_merchant : checkout.data.fee_merchant,
                    fee_customer : checkout.data.fee_customer,
                    total_fee : checkout.data.total_fee,
                    amount_received : checkout.data.amount_received,
                    pay_code : checkout.data.pay_code,
                    pay_url : checkout.data.pay_url,
                    checkout_url : checkout.data.checkout_url,
                    status : checkout.data.status,
                    expired_time : checkout.data.expired_time,
                    instructions : checkout.data.instructions
                }
                var dataapi = {
                    id : datatrx.id,
                    noRefCheckout : checkout.data.reference,
                    tripayReq : tripay_reff
                }
                console.log(dataapi);
                var res =  await CheckOutTrx(dataapi,{id:"btnCheckOut",txtProcess:"Memproses...",txtfinish:"Checkout"});
                if(res.success){
                    Storage.set("payment",dataapi);
                    window.location.href = '@Url.Action("InstruksiPembayaran", "Pembayaran")';
                }
            } else {
                 console.log(checkout);
                 Swal.fire('Gagal!', checkout.message, 'warning');
            }
        }
        else
        {
            showToast("Data tidak valid");
        }
    }

    

</script>

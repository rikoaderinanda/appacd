<style>
    .card-option {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .card-option:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    .card-option.active {
        border-width: 2px !important;
        background: #f0f9ff;
    }

    #listJadwal .jadwal-item {
        background: #fff;
        border-radius: 8px;
        padding: 10px 14px;
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    #listJadwal .jadwal-num {
        width: 30px;
        height: 30px;
        border-radius: 20%;
        background: var(--bs-primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 20px;
    }
    /* Animasi untuk list jadwal */
    @@keyframes fadeSlideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #listJadwal .jadwal-item {
        animation: fadeSlideUp 0.3s ease-in-out;
    }

    /* Glow untuk paket aktif */
    .card-option.active {
        border-width: 2px !important;
        background: linear-gradient(135deg, #e6f7ff, #f0f9ff);
        box-shadow: 0 0 10px rgba(0, 162, 255, 0.3);
    }

    /* Input tanggal flat */
    .tanggal-input {
        border-radius: 6px;
        border: 1px solid #ddd;
    }
    
    .tanggal-input:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 5px rgba(0,123,255,0.3);
    }
</style>

<div class="items-group" style="display: none; animation: fadeIn 0.4s ease-in-out;" id="panelberlangganan">
    <div class="alert alert-warning d-flex justify-content-between align-items-center mb-3 shadow-sm rounded">
        <h6 class="fw-bold mb-0">Coba cek berlangganan</h6>
        <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="cekLangganan">
        </div>
    </div>
    <!-- Pilihan Paket -->
    <div id="paketLangganan" style="display: none; animation: fadeIn 0.4s ease-in-out;" class="row g-3 mb-4">
    </div>
    
</div>

<script>

    // Toggle paket & jadwal
    document.getElementById("cekLangganan").addEventListener("change", function () {
        const paket = document.getElementById("paketLangganan");
        paket.style.display = this.checked ? "flex" : "none";
        
        const jadwal = document.getElementById("jadwalLangganan");
        jadwal.style.display = this.checked ? "flex" : "none";
        
        if(this.checked){
            //$("#jadwalLangganan").show();
            $("#sessionWaktuKunjunganReguler").hide();
            RegAtauMember = "MEMBER";
            document.querySelectorAll('.card-option').forEach(c => c.classList.remove('active'));
            TotalHargaAkhir = 0;
            paketDipilih = null;
            KunjunganReg = null;
            
        }
        else{
            //$("#jadwalLangganan").hide();
            $("#sessionWaktuKunjunganReguler").show();
            RegAtauMember = "REG";
            paketDipilih = null;
            cartMember = null;
            KunjunganMember = [];
            TotalHargaAkhir = cartReguler.reduce((sum, item) => sum + (item.after_diskon * item.qty), 0);
        }
    });

    const bulanIndo = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni",
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
    ];

    let paketDipilih = null;

    // Event delegation untuk card-option
    document.getElementById("paketLangganan").addEventListener("click", function (e) {
        const card = e.target.closest('.card-option');
        if (!card) return;
        
        document.querySelectorAll('.card-option').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        TotalHargaAkhir = 0;
        paketDipilih = card.getAttribute('data-value');

        let diskon = card.getAttribute('data-diskon');
        let interval = card.getAttribute('data-interval');
        let qty_member = card.getAttribute('data-qty');
        
        let totalHarga = cartReguler.reduce((sum, item) => sum + (item.sub_total), 0);
        
        TotalHargaAkhir = (totalHarga - ((totalHarga*diskon)/100))*qty_member;
        paketMember = {
            id:card.getAttribute('data-id'),
            nama_layanan: card.getAttribute('data-nama_layanan'),
            nama_paket: card.getAttribute('data-nama_paket'),
            qty:qty_member,
            interval:interval,
            periode:paketDipilih,
            diskon:card.getAttribute('data-diskon'),
            deskripsi:card.getAttribute('data-deskripsi'),
            total:TotalHargaAkhir
        }
        

        // Tampilkan pengaturan jadwal
        document.getElementById('jadwalLangganan').style.display = 'block';

        // Reset input tanggal
        document.getElementById('tanggalAwal').value = '';

        // Kosongkan list jadwal
        document.getElementById('listJadwal').innerHTML =
            `<p class="text-muted small m-0 p-3">Jadwal akan muncul setelah memilih paket & tanggal mulai.</p>`;
    });

    function LoadcartMember(cart) {
        let totalHarga = cart.reduce((sum, item) => sum + (item.sub_total), 0);
        let diskon = cart.reduce((sum, item) => sum + (item.diskon * item.qty), 0);
        let Qty = cart.reduce((sum, item) => sum + (item.qty), 0);

        console.log(cart);
        callApi({
            url: '/api/Layanan/PaketLangganan?Id=@ViewData["Id"]',
            method: 'GET',
            success: function (data) {
                var html = $.map(data, function (item) {
                    let diskon_berlangganan = ((totalHarga*item.diskon_persen)/100)
                    let harga = totalHarga - diskon_berlangganan;
                    
                    let TotalPaket = harga * item.frekuensi;

                    let hemat = diskon_berlangganan*item.frekuensi;
                    var scr =`
                        <div class="col-md-4">
                            <div class="card card-option shadow-sm h-100" 
                                data-id ="${item.id}"
                                data-nama_layanan ="${item.nama_layanan}"
                                data-nama_paket ="${item.nama_paket}"
                                data-qty="${item.frekuensi}"
                                data-periode="${item.periode}"
                                data-diskon = "${item.diskon_persen}"
                                data-deskripsi="${item.deskripsi}"
                                data-interval="${item.interval}"
                                data-value="${item.periode}" 
                                data-total="${TotalPaket}"
                                data-harga_satuan = "${harga}"
                                >
                                <div class="card-body text-center">
                                    <h6 class="fw-bold">${item.nama_paket}</h6>
                                    <p class="text-muted small">${item.deskripsi}</p>
                                    <h4 class="text-primary fw-bold">
                                        ${formatRupiah(TotalPaket)}
                                        <span class="fs-6 text-muted">/tahun</span>
                                    </h4>
                                    <span class="badge bg-success">Hemat ${formatRupiah(hemat)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    //console.log(scr);
                    return scr;
                    
                }).join('');
                $("#paketLangganan").html(html);
            },
            error: function () {
                $('#paketLangganan').html('<p class="text-center text-muted py-4">oopss.. coba cek koneksi internet kamu.</p>');
            },
            onBeforeSend: function () {
                $('#paketLangganan').html('<p class="text-center text-muted py-4">sedang memuat data ...</p>');
            },
            onComplete: function () {}
        });
    }
</script>

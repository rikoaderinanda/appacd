<style>
    .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 6px;
    }
    /* Icon input group */
    .input-group-text {
        border-radius: 10px 0 0 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    /* Animation */
    @@keyframes fadeIn {
        from {opacity: 0; transform: translateY(10px);}
        to {opacity: 1; transform: translateY(0);}
    }
</style>

<div class="mb-3">
    <label class="form-label fw-bold">Pilih Kontak</label>

    <!-- List Kontak -->
    <div class="list-group mb-3" id="ListKontak">
    </div>

    <!-- Form Kontak Baru -->
    <div id="formKontak" class="mt-3" style="display: none;">
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                <input type="text" class="form-control" id="nama" name="nama"
                       placeholder="Masukkan nama lengkap">
                <div class="invalid-feedback">Nama wajib diisi.</div>
            </div>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-whatsapp"></i></span>
                <input type="tel" class="form-control" id="whatsapp" name="whatsapp" placeholder="08xxxxxxxxxx">
                <div class="invalid-feedback">WhatsApp wajib diisi.</div>
            </div>
        </div>
    </div>

    <div class="d-flex flex-column mb-3">
        <button id="btnSimpanKontak" type="button" class="btn btn-success mb-2" style="display: none;">Simpan</button>
        <button id="btnNewKontak" type="button" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> 
            Kontak Baru
        </button>
    </div>
</div>

<script>
const btnNewKontak = document.getElementById("btnNewKontak");
const btnSimpanKontak = document.getElementById("btnSimpanKontak");
const formKontak = document.getElementById("formKontak");

document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
});

$(document).on('click', 'input[name="pilihKontak"]', function() {
    var selectedValue = $(this).val();
    var values = selectedValue.split(':');
    var idKontak = values[0];
    var namaKontak = values[1];
    var nomorKontak = values[2];
    kontakPelanggan = {
        id : idKontak,
        nama:namaKontak,
        nomor:nomorKontak
    };
});

btnNewKontak.addEventListener("click", function () {
    if (formKontak.style.display === "none" || formKontak.style.display === "") {
        // Munculkan form
        formKontak.style.display = "block";
        btnSimpanKontak.style.display = "block";
        btnNewKontak.innerHTML = '<i class="bi bi-x-circle me-1"></i> Batal';
    } else {
        // Sembunyikan form
        formKontak.style.display = "none";
        btnNewKontak.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Kontak Baru';
        btnSimpanKontak.style.display = "none";
    }
});

btnSimpanKontak.addEventListener("click", function () {
    var nama = $("#nama").val();
    var whatsapp = $("#whatsapp").val();
    if(nama !="" && whatsapp!=""){
        var _Data = {
            UserId : IdUser,
            NamaKontak : nama,
            NomorKontak : whatsapp
        }
        callApi({
            url: "/api/Layanan/SimpanKontak",
            method: 'POST',
            data:_Data,
            success: function (res) {
                if(!res.success){
                    Swal.fire('Gagal!',res.message, 'warning');    
                }
            },
            error: function (err) {
                Swal.fire('Gagal!', 'data gagal disimpan.'+err.message, 'warning');
            },
            onBeforeSend : function () {
                $("#btnSimpanKontak").prop("disabled", true).text("Memproses...");
            },
            onComplete : function () {
                $("#btnSimpanKontak").prop("disabled", false).text("Simpan");
                formKontak.style.display = "none";
                btnNewKontak.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Kontak Baru';  
                btnSimpanKontak.style.display = "none";
                LoadDataKontak();
            }
        });  
    }
    else{
        showToast("silahkan isi nama dan kontak")
    }
    
});

function LoadDataKontak(){
    callApi({
            url: '/api/Layanan/ListKontakUser?Id='+IdUser,
            method: 'GET',
            success: function (data) {
                console.log(data);
                var html = $.map(data, function (item) {
                    var scr = `
                        <label class="list-group-item d-flex align-items-start position-relative">
                            <input class="form-check-input me-2 mt-1" type="radio" name="pilihKontak" value="${item.id}:${item.nama_kontak}:${item.nomor_kontak}">
                            <div>
                                <div class="fw-semibold">${item.nama_kontak}</div>
                                <small class="text-muted">+${item.nomor_kontak}</small>
                            </div>
                            
                            <button 
                                type="button" class="btn-close position-absolute top-0 end-0 m-2" 
                                aria-label="Hapus"
                                onclick="deleteKontak(${item.id})"
                            ></button>
                        </label>
                    `;
                    return scr;
                }).join('');

                if(data.length == 0){
                    html = `
                        <p class="text-center text-muted py-4">tidak ada kontak yang disimpan...</p>
                    `;
                }
                $("#ListKontak").html(html);
                if(!isEmptyObject(kontakPelanggan)){
                    document.querySelector(
                        `input[name="pilihKontak"][value="${kontakPelanggan.id}:${kontakPelanggan.nama}:${kontakPelanggan.nomor}"]`
                    ).checked = true;
                }
                else{
                    kontakPelanggan = {};
                }
            },
            error: function () {
                $('#ListKontak').html('<p class="text-center text-muted py-4">oopss.. coba cek koneksi internet kamu.</p>');
            },
            onBeforeSend: function () {
                $('#ListKontak').html('<p class="text-center text-muted py-4">sedang memuat data ...</p>');
            },
            onComplete: function () {}
    });
}

function deleteKontak(id){
    callApi({
        url: "/api/Layanan/DeleteKontak/"+id,
        method: 'DELETE',
        success: function (res) {
            LoadDataKontak();
        },
        error: function (err) {
            Swal.fire('Gagal!', 'data gagal disimpan.', 'warning');
        },
        onBeforeSend : function () {
            
        },
        onComplete : function () {
            
        }
    });  
}

</script>
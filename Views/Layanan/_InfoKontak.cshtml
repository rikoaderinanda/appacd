<style>
    .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 6px;
    }
    /* Icon input group */
    .input-group-text {
        border-radius: 10px 0 0 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    /* Animation */
    @@keyframes fadeIn {
        from {opacity: 0; transform: translateY(10px);}
        to {opacity: 1; transform: translateY(0);}
    }
</style>

<div class="mb-3 position-relative">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fw-bold m-0">Pilih Kontak</label>
        <button id="btnNewKontak" type="button" 
                class="btn btn-sm btn-primary">
            <i class="bi bi-plus-lg"></i> Kontak Baru
        </button>
    </div>

    <!-- List Kontak -->
    <div class="list-group mb-3" id="ListKontak"></div>

    <!-- Form Kontak Baru -->
    <div id="formKontak" class="mt-3 mb-3" style="display: none;">
        <div class="text-center mb-4">
            <h4 class="fw-bold text-primary mb-1">
                <i class="bi bi-person-plus-fill me-2"></i> Tambah Kontak Baru
            </h4>
            <p class="text-muted small">
                Lengkapi informasi kontak Anda agar kami dapat menghubungi dengan mudah.
            </p>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-person"></i></span>
                <input type="text" class="form-control" id="nama" name="nama"
                       placeholder="Masukkan nama lengkap">
                <div class="invalid-feedback">Nama wajib diisi.</div>
            </div>
        </div>
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-whatsapp"></i></span>
                <input type="tel" class="form-control" id="whatsapp" name="whatsapp" placeholder="08xxxxxxxxxx">
                <div class="invalid-feedback">WhatsApp wajib diisi.</div>
            </div>
        </div>
    </div>

    <!-- Tombol Simpan (hanya muncul saat form aktif) -->
    <div class="d-flex justify-content-end">
        <button id="btnSimpanKontak" type="button" class="btn btn-success btn-sm" style="display: none;">
            <i class="bi bi-check2-circle me-1"></i> Simpan
        </button>
    </div>
</div>

<script>
const btnNewKontak = document.getElementById("btnNewKontak");
const btnSimpanKontak = document.getElementById("btnSimpanKontak");
const formKontak = document.getElementById("formKontak");
const ListKontak = document.getElementById("ListKontak");
document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.checked = false;
});

$(document).on('click', 'input[name="pilihKontak"]', function() {
    var selectedValue = $(this).val();
    var values = selectedValue.split(':');
    var idKontak = values[0];
    var namaKontak = values[1];
    var nomorKontak = values[2];
    kontakPelanggan = {
        id : idKontak,
        nama:namaKontak,
        nomor:nomorKontak
    };
});

btnNewKontak.addEventListener("click", function () {
    if (formKontak.style.display === "none" || formKontak.style.display === "") {
        // Munculkan form
        formKontak.style.display = "block";
        btnSimpanKontak.style.display = "block";
        ListKontak.style.display = "none";
        btnNewKontak.innerHTML = '<i class="bi bi-x-circle me-1"></i> Batal';
    } else {
        // Sembunyikan form
        formKontak.style.display = "none";
        btnNewKontak.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Kontak Baru';
        btnSimpanKontak.style.display = "none";
        ListKontak.style.display = "block";
    }
});

btnSimpanKontak.addEventListener("click", function () {
    simpanKontak();
});

// Format otomatis untuk nomor WhatsApp
document.getElementById("whatsapp").addEventListener("input", function() {
    let val = this.value.replace(/\D/g, ""); // hapus non-digit

    if (val.startsWith("0")) {
        val = "62" + val.substring(1);
    } else if (val.startsWith("62")) {
        // sudah benar
    } else if (val.startsWith("8")) {
        val = "62" + val;
    }

    if (val) {
        this.value = "+" + val;
    } else {
        this.value = "";
    }
});

function LoadDataKontak(){
    callApi({
            url: '/api/Layanan/ListKontakUser?Id='+IdUser,
            method: 'GET',
            success: function (data) {
                console.log(data);
                var html = $.map(data, function (item) {
                    var scr = `
                        <label class="list-group-item d-flex align-items-start position-relative">
                            <input class="form-check-input me-2 mt-1" type="radio" name="pilihKontak" value="${item.id}:${item.nama_kontak}:${item.nomor_kontak}">
                            <div>
                                <div class="fw-semibold">${item.nama_kontak}</div>
                                <small class="text-muted">${item.nomor_kontak}</small>
                            </div>
                            
                            <button 
                                type="button" 
                                class="btn-close position-absolute top-0 end-0 m-2" 
                                style="transform: scale(0.7); font-size: 0.8rem;" 
                                aria-label="Hapus"
                                onclick="deleteKontak(${item.id})">
                            </button>
                        </label>
                    `;
                    return scr;
                }).join('');

                if(data.length == 0){
                    html = `
                        <p class="text-center text-muted py-4">tidak ada kontak yang disimpan...</p>
                    `;
                }
                $("#ListKontak").html(html);
                if(!isEmptyObject(kontakPelanggan)){
                    document.querySelector(
                        `input[name="pilihKontak"][value="${kontakPelanggan.id}:${kontakPelanggan.nama}:${kontakPelanggan.nomor}"]`
                    ).checked = true;
                }
                else{
                    kontakPelanggan = {};
                }
            },
            error: function () {
                $('#ListKontak').html('<p class="text-center text-muted py-4">oopss.. coba cek koneksi internet kamu.</p>');
            },
            onBeforeSend: function () {
                $('#ListKontak').html('<p class="text-center text-muted py-4">sedang memuat data ...</p>');
            },
            onComplete: function () {}
    });
}

function simpanKontak(){
    const nama = document.getElementById("nama");
    const whatsapp = document.getElementById("whatsapp");

    let valid = true;

    // Cek nama
    if (nama.value.trim() === "") {
        nama.classList.add("is-invalid");
        valid = false;
    } else {
        nama.classList.remove("is-invalid");
        nama.classList.add("is-valid");
    }

    // Cek nomor WhatsApp (regex: +62 diikuti 8â€“13 digit)
    const regexWa = /^\+62[0-9]{8,13}$/;
    if (!regexWa.test(whatsapp.value)) {
        whatsapp.classList.add("is-invalid");
        valid = false;
    } else {
        whatsapp.classList.remove("is-invalid");
        whatsapp.classList.add("is-valid");
    }

    // Kalau tidak valid, hentikan di sini
    if (!valid) {
        return;
    }

    // ---- Kalau valid, lakukan ini ----
    var _Data = {
        UserId : IdUser,
        NamaKontak : nama.value,
        NomorKontak : whatsapp.value
    }
    console.log(_Data);
    callApi({
        url: "/api/Layanan/SimpanKontak",
        method: 'POST',
        data:_Data,
        success: function (res) {
            if(!res.success){
                Swal.fire('Gagal!',res.message, 'warning');    
            }
        },
        error: function (err) {
            Swal.fire('Gagal!', 'data gagal disimpan.'+err.message, 'warning');
        },
        onBeforeSend : function () {
            $("#btnSimpanKontak").prop("disabled", true).text("Memproses...");
        },
        onComplete : function () {
            $("#btnSimpanKontak").prop("disabled", false).text("Simpan");
            formKontak.style.display = "none";
            btnNewKontak.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Kontak Baru';  
            btnSimpanKontak.style.display = "none";
            ListKontak.style.display = "block";
            LoadDataKontak();
            // Reset form setelah simpan
            nama.value = "";
            whatsapp.value = "";
            nama.classList.remove("is-valid");
            whatsapp.classList.remove("is-valid");
            document.getElementById("formKontak").style.display = "none";
            document.getElementById("btnSimpanKontak").style.display = "none";
        }
    });  
}

function deleteKontak(id){
    callApi({
        url: "/api/Layanan/DeleteKontak/"+id,
        method: 'DELETE',
        success: function (res) {
            LoadDataKontak();
        },
        error: function (err) {
            Swal.fire('Gagal!', 'data gagal disimpan.', 'warning');
        },
        onBeforeSend : function () {
            
        },
        onComplete : function () {
            
        }
    });  
}

</script>
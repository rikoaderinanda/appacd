<style>
    /* ===== Styling Channel Payment ===== */
    .payment-channel-list {
        display: flex;
        flex-direction: column;
        gap: 0px;
    }

    .channel-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.25s ease;
        cursor: pointer;
    }


    .channel-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }

    .channel-card input[type="radio"]:checked + .channel-content {
        border: 2px solid #0d6efd;
        border-radius: 8px;
        padding: 2px;
        background-color: #f0f8ff;
    }

    .channel-content {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        gap: 16px;
    }

    .channel-logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 6px;
        border: 1px solid #eee;
    }

    .channel-info {
        @* display: flex;
        flex-direction: column; *@
    }

    .channel-name {
        font-weight: 300;
        font-size: 12px;
        color: #333;
        margin-bottom: 0px;
    }

    .channel-fee {
        font-size: 12px;
        color: #888;
    }
</style>
<div class="main-title text-center mb-4">
    <h3 class="fw-bold text-primary mb-2">
        <i class="bi bi-credit-card me-2"></i> Selesaikan Pembayaran Anda
    </h3>
    <p class="text-muted small mb-0">
        Periksa kembali detail transaksi, lalu pilih metode pembayaran yang paling sesuai untuk Anda.
    </p>
</div>

<div class="fw-semibold text-primary mb-1">
    <i class="bi bi-person-vcard me-1"></i> Kontak & Alamat
</div>

<div class="p-3 border rounded bg-light medium mb-2">
    <!-- Kontak (1 baris) -->
    <div class="mb-2 mt-2" id="KontakInfo">
    </div>
    <hr>
    <!-- Pemisah -->
    <div class="mb-2 mt-2" id="AlamatInfo"></div>
</div>


<div class="position-relative" style="margin-bottom:20px;margin-top:10px;">
    <strong >Detail Transaksi</strong>
        <a id="toggleDetailBtn" href="#"
            class="btn btn-sm position-absolute top-0 end-0">
            <i id="toggleIcon" class="bi bi-chevron-down"></i>
        </a>
    </div>

<!-- List Transaksi -->
<div id="listTransaksi" class="mb-3 mt-20" style="display:block;">
</div>

<!-- Total -->
<div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm rounded-pill px-3 py-2 mt-20">
    <span class="fw-bold">Total Transaksi:</span>
    <span class="fw-bold text-primary fs-5" id="totalTransaksi"></span>
</div>

<!-- Metode Pembayaran -->
<strong>Metode Pembayaran</strong>
<div class="position-relative mb-4 mt-2">
    <input class="form-control ps-5 pe-5 shadow-sm rounded-pill" 
           type="text" placeholder="Cari" id="searchInput">
    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
    <button type="button"
        class="btn btn-light btn-sm rounded-circle shadow-sm position-absolute top-50 end-0 translate-middle-y me-2"
        onclick="GetChannelPembayaran()" title="Segarkan">
        <i class="bi bi-arrow-clockwise text-primary"></i>
    </button>
</div>

<div class="accordion mt-4 mb-3" id="channelAccordion"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Set total awal
        //updateTotalTransaksi(185000);

        // Load channel payment
        @* const savedChannels = Storage.get("ChannelPayment");
        if (savedChannels) {
            SetChannelPembayaranV2(savedChannels, "");
        } else {
            GetChannelPembayaran();
        } *@

        // Event search
        $('#searchInput').on('keydown', function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const keyword = $(this).val().trim();
                const ChannelPayment = Storage.get("ChannelPayment");
                $('#btnCheckout').fadeOut();

                SetChannelPembayaranV2(ChannelPayment, keyword || "");
            }
        });
        // Toggle detail transaksi
        document.getElementById("toggleDetailBtn").addEventListener("click", function () {
            const list = document.getElementById("listTransaksi");
            const icon = document.getElementById("toggleIcon");
            const isHidden = list.style.display === "none";

            list.style.display = isHidden ? "block" : "none";
            icon.className = isHidden ? "bi bi-chevron-up" : "bi bi-chevron-down";

            
        });
    });

    function updateTotalTransaksi(total) {
        document.getElementById("totalTransaksi").textContent = formatRupiah(total);
    }

    function GetChannelPembayaran() {
        callApi({
            url: `/api/Tripay/GetPaymentChannelsV2`,
            method: 'GET',
            success: function (res) {
                Storage.set("ChannelPayment", res);
                SetChannelPembayaranV2(res, "");
            },
            error: function () {
                Swal.fire('Gagal!', 'Proses gagal.', 'warning');
            },
            onBeforeSend: function () {
                $('#channelAccordion').html('<p class="text-center text-muted py-4">Sedang memuat data...</p>');
            }
        });
    }

    function SetChannelPembayaranV2(res, cari) {
        console.log(res);
        console.log(TotalHargaAkhir);
        if (cari === "") $("#searchInput").val("");

        // Grouping berdasarkan "group"
        const grouped = {};
        const regex = cari ? new RegExp(cari, "i") : null;

        res.forEach(item => {
            if (!regex || regex.test(item.name)) {
                if (!grouped[item.group]) grouped[item.group] = [];
                grouped[item.group].push(item);
            }
        });

        const accordion = $("#channelAccordion");
        accordion.empty();

        let idx = 0;
        Object.keys(grouped).forEach(group => {
            const collapseId = `collapse-${idx}`;
            const headerId = `heading-${idx}`;
            
            const items = grouped[group].map(item => {
                let totalFeeTripay = 0;

                if (item.total_fee.flat > 0) {
                    totalFeeTripay = item.total_fee.flat;
                } else {
                    totalFeeTripay = (item.total_fee.percent*TotalHargaAkhir)/100;
                }

                return `
                    <div class="payment-channel-list">
                        <label class="channel-card">
                            <input type="radio" name="payment_channel" value="${item.code}" class="form-check-input d-none" />
                            <div class="channel-content">
                                <img src="${item.icon_url}" alt="${item.name}" width="80" class="channel-logo">
                                <div class="channel-info">
                                    <span class="channel-name">${item.name}</span>
                                    <br>
                                    <span class="channel-fee">Biaya admin: ${formatRupiah(totalFeeTripay)}</span>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join("");

            const section = `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="${headerId}">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                                aria-expanded="${idx === 0}" aria-controls="${collapseId}">
                            ${group}
                        </button>
                    </h2>
                    <div id="${collapseId}" 
                         class="accordion-collapse collapse ${cari ? 'show' : ''}" 
                         aria-labelledby="${headerId}" data-bs-parent="#channelAccordion">
                        <div class="accordion-body">
                            ${items}
                        </div>
                    </div>
                </div>
            `;

            accordion.append(section);
            idx++;
        });
    }

</script>

<style>
    .main-title h5 {
    font-size: 1.25rem;
    font-weight: 600;
}

.main-title p {
    font-size: 0.9rem;
    color: #6c757d; /* abu-abu Bootstrap */
}
</style>
<div class="main-title text-left mb-4">
  <h5 class="mb-1 fw-bold text-primary">Perbaikan AC</h5>
  <p class="text-muted small mb-0">Beritahu kami masalah AC agar teknisi siap dengan solusi</p>
</div>
<div class="items-group">
    <div class="form-group">
        <div class="row g-2">
            <!-- Loading skeletons -->
            <div id="ItemKeluhanMasalah">
            </div>
            <div class="col-12 d-flex flex-column p-0 wrapper" style="margin-left:5px;">
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 mr-3" style="margin-top:-5px;">
                    <span>Keluhan Lainnya</span>
                    <input class="form-check-input ms-2" type="checkbox" id="keluhan5"
                        name="KeluhanAC" value="Keluhan Lainnya">
                </div>
                
                <!-- Ini textarea disembunyikan dulu -->
                <textarea class="form-control mt-2" name="CatatanKeluhanLainnya"
                        placeholder="Tulis catatan keluhan lainnya di sini..."
                        id="catatanKeluhanLainnya"
                        style="display: none;"></textarea>
            </div>
        </div>
    </div>
</div>
<script>

    var $ = window.jQuery;
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof window.jQuery === 'undefined') {
            console.error('jQuery is not loaded.');
            return;
        }
        LoadDataKeluhan();
        // Event: ketika checkbox "Lainnya" diubah atau textarea diketik
        $('#keluhan5').on('change', function () {
            if ($(this).is(':checked')) {
                $('#catatanKeluhanLainnya').show();
            } else {
                $('#catatanKeluhanLainnya').hide();
            }
            updateKeluhanLocalStorage();
        });
        $(document).on('input', 'textarea[name="CatatanKeluhanLainnya"]', function () {
            if ($('#keluhan5').is(':checked')) {
                updateKeluhanLocalStorage();
            }
        });

        $(document).on('change', '#ItemKeluhanMasalah input[type="checkbox"]', function () {
            updateKeluhanLocalStorage();
        });
    });
    function updateKeluhanLocalStorage() {
        keluhanPerbaikan = [];
        // Ambil semua checkbox yang dicentang
        $('#ItemKeluhanMasalah input[type="checkbox"]').each(function () {
            if ($(this).is(':checked')) {
                var jeniskeluhan = $(this).closest('.d-flex').find('span').text().trim();
                var id = $(this).val();
                keluhanPerbaikan.push(
                    {
                        "id":id,
                        "jeniskeluhan":jeniskeluhan
                    }
                );
            }
        });

        // Tambahkan keluhan lainnya jika dicentang
        if ($('#keluhan5').is(':checked')) {
            var catatan = $('textarea[name="CatatanKeluhanLainnya"]').val();
            if (catatan && catatan.trim() !== '') {
                keluhanPerbaikan.push(
                    {
                        "id":99,
                        "jeniskeluhan":catatan.trim()
                    }
                )
                    
            }
        }
    }
    function LoadDataKeluhan(){
        const Keluhan = Storage.get('keluhan');
        callApi({
            url: '/api/Layanan/KeluhanMasalah?Id=@ViewData["Id"]',
            method: 'GET',
            success: function (data) {
                var html = $.map(data, function (item) {
                    var scr = "";
                    if (item.typeinput == "checkbox") {
                        var isChecked = false;
                        var isChecked = Array.isArray(Keluhan) && Keluhan.some(function (storedItem) {
                            return storedItem.id == item.id;
                        });

                        if (isChecked) {
                            scr = `<div class="col-12 d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                                <span>${item.keluhan}</span>
                                <input class="form-check-input ms-2" type="${item.typeinput}" id="Keluhan${item.id}" name="" value="${item.id}" checked>
                            </div>`;
                        }
                        else {
                            scr = `<div class="col-12 d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                                <span>${item.keluhan}</span>
                                <input class="form-check-input ms-2" type="${item.typeinput}" id="Keluhan${item.id}" name="" value="${item.id}">
                            </div>`;
                        }

                    }
                    return scr;
                }).join('');

                $('#ItemKeluhanMasalah').html(html);
                var isChecked = false;
                var isChecked = Array.isArray(Keluhan) && Keluhan.some(function (storedItem) {
                    return storedItem.id == 99;
                });

                if (isChecked) {
                    const item = Keluhan.find(obj => obj.id === "99");
                    const val = item ? item.val : null;
                    $("#keluhan5").prop("checked", true);
                    $('[name="CatatanKeluhanLainnya"]').show();
                    $('[name="CatatanKeluhanLainnya"]').val(val);
                }
                lazyAnimateItems("ItemKeluhanMasalah");
                console.log("ini dia");
                console.log(keluhanPerbaikan);
            },
            error: function (err) {
                alert('Error: ' + err);
            },
            onBeforeSend: function () {
                
                $('#ItemKeluhanMasalah').html(`
                    <p class="text-center text-muted py-4">sedang memuat data.....</p>`
                );
            },
        });
    }
</script>